---
import Layout from '../../layouts/Layout.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = (await getCollection('blog')).filter((p) => !p.data.draft);
  const tags = new Set<string>();
  for (const post of posts) {
    for (const tag of post.data.tags) {
      if (tag) tags.add(tag);
    }
  }
  return [...tags].map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter((p) => p.data.tags.includes(tag))
        .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()),
    },
  }));
}

const { tag, posts } = Astro.props;
---

<Layout title={`Tag: ${tag}`} description={`Posts tagged with ${tag}`}>
  <h1>Tag: {tag}</h1>
  <p>{posts.length} post{posts.length !== 1 ? 's' : ''}</p>
  <ul class="post-list">
    {posts.map((post: any) => (
      <PostCard
        title={post.data.title}
        date={post.data.date}
        slug={post.id}
        tags={post.data.tags}
        language={post.data.language}
      />
    ))}
  </ul>
  <p><a href="/tags/">‚Üê All tags</a></p>
</Layout>
